---
title: "Reach"
author: "Michael Rustler"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Reach}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Install R Package

```{r eval=FALSE}
# Enable this universe
options(repos = c(
  kwbr = 'https://kwb-r.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))

# Install R package
install.packages('wasserportal')

```

## Get GW Quality from Wasserportal

```{r}
# Load R package
library(wasserportal)

categories <- wasserportal::readPackageFile(file = "categories.csv") 

cas_reach <- wasserportal::readPackageFile(file = "cas_reach.csv") %>% 
  dplyr::left_join(categories)

cas_wasserportal <- wasserportal::readPackageFile(file = "cas_wasserportal.csv") %>%  
  dplyr::inner_join(cas_reach, by = "cas_number") 

### Remove duplicated Wasserportal substances (same CAS number but different, names!)
cas_wasserportal_clean <- wasserportal::readPackageFile(file = "cas_wasserportal.csv") %>%  
  dplyr::count(cas_number) %>%
  dplyr::select(-n) %>% 
  dplyr::filter(!is.na(cas_number)) %>% 
  dplyr::inner_join(cas_reach, by = "cas_number") 


### For details see:
### https://kwb-r.github.io/wasserportal/articles/groundwater.html
### JSON files (see below) are build every day automatically at 5a.m. with
### continious integration, for build status, see here:
### https://github.com/KWB-R/wasserportal/actions/workflows/pkgdown.yaml

### GW quality (all available parameters!)
gwq_master <- jsonlite::fromJSON("https://kwb-r.github.io/wasserportal/stations_gwq_master.json")
gwq_data <- jsonlite::fromJSON("https://kwb-r.github.io/wasserportal/stations_gwq_data.json") %>%
  #dplyr::filter(Parameter %in% cas_wasserportal$Parameter) %>% 
  dplyr::inner_join(cas_wasserportal, by = "Parameter") %>%
  dplyr::mutate(Messstellennummer = as.character(Messstellennummer),
## CensorCode: either "below" (less than) for concentration below detection limit 
## (value is detection limit) or "nc" (not censored) for concentration above 
## detection limit
                CensorCode = dplyr::case_when(Messwert <= 0 ~ "lt",
                                              TRUE ~ "nc"),
                Messwert = dplyr::case_when(Messwert < 0 ~ abs(Messwert),
### Only two decimal numbers are exported by Wasserportal, but some sustances 
### have lower detection limit, e.g. 0.002 which results in -0.00 export, thus 
### the dummy detection limit 0.00999 was introduced (until fixed by Senate: 
### Christoph will sent a email to Matthias SchrÃ¶der)
                                            Messwert == 0 ~ 0.009999, 
                                            TRUE ~ Messwert)) %>%
  dplyr::left_join(gwq_master, by = c("Messstellennummer" = "Nummer"))

 readr::write_csv(gwq_subs, "gwq_subs.csv")

gwq_subs <- gwq_data %>%  
  dplyr::count(.data$cas_number, .data$CensorCode) %>% 
  tidyr::pivot_wider(names_from = CensorCode, values_from = n) %>% 
  dplyr::mutate(lt = ifelse(is.na(lt), 0, lt), 
                nc = ifelse(is.na(nc), 0, nc),
                n_total = lt + nc, 
                percent_nc = 100*nc/n_total) %>% 
  dplyr::rename(n_lt = lt, 
                n_nc = nc) %>% 
  dplyr::left_join(cas_reach[, c("category", "category_name", "name", "cas_number")]) %>%
  dplyr::rename(name_uba = name) %>% 
  dplyr::select(category, category_name, name_uba, cas_number,n_lt, n_nc, n_total, percent_nc)

 DT::datatable(gwq_subs, filter = "top", rownames = FALSE)

gwq_data_export <- gwq_data %>% 
   dplyr::rename(name_uba = name) %>% 
   dplyr::select(category, category_name,
                     cas_number,
                     name_uba,
                     Messstellennummer,
                     Datum,
                     CensorCode, 
                     Messwert,
                     Einheit)
  
 
gwq_subs_stations <- gwq_data %>%  
  dplyr::count(.data$cas_number,
                  .data$Messstellennummer,
                  .data$CensorCode) %>%
  tidyr::pivot_wider(names_from = CensorCode, values_from = n) %>% 
  dplyr::mutate(lt = ifelse(is.na(lt), 0, lt),
                nc = ifelse(is.na(nc), 0, nc),
                n_total = lt + nc, 
                percent_nc = 100*nc/n_total) %>% 
  dplyr::rename(n_lt = lt, 
                n_nc = nc) %>% 
  dplyr::left_join(cas_reach[, c("category", "category_name",   "name", "cas_number")]) %>%
  dplyr::rename(name_uba = name) %>% 
  dplyr::select(category, category_name, name_uba, cas_number, Messstellennummer, n_lt, n_nc, n_total, percent_nc) %>% 
  dplyr::left_join(gwq_master, by = c(Messstellennummer = "Nummer"))


 gwq_subs_by_category_and_station <- gwq_subs_stations  %>% 
  dplyr::group_by(.data$category,
                  .data$category_name,
                  .data$Messstellennummer) %>% 
  dplyr::summarise(n_lt = sum(n_lt), 
                   n_nc = sum(n_nc), 
                   n_total = sum(n_total)) %>% 
   dplyr::mutate(percent_nc = 100*n_nc/n_total)

gwq_subs_stations_n_abovedetection <- gwq_subs_stations  %>% 
  dplyr::filter(n_nc > 0) %>% 
  dplyr::group_by(.data$cas_number) %>% 
  dplyr::summarise(n_stations_abovedetection = dplyr::n()) 
  
    
gwq_subs_stations_n_all <- gwq_subs_stations %>% 
  dplyr::group_by(category, 
                  category_name, 
                  name_uba, 
                  cas_number) %>% 
  dplyr::summarise(n_stations_sampled = dplyr::n(),
                   n_lt = sum(n_lt), 
                   n_nc = sum(n_nc), 
                   n_total = sum(n_total)) %>% 
  dplyr::left_join(gwq_subs_stations_n_abovedetection) %>% 
  dplyr::mutate(n_stations_abovedetection = ifelse(is.na(n_stations_abovedetection),
                                                   0,
                                                   n_stations_abovedetection),
                n_nc = ifelse(is.na(n_nc), 0, n_nc), 
                n_lt = ifelse(is.na(n_lt), 0, n_lt),
                percent_nc = 100*n_nc/n_total,
                percent_stations_abovedetection = 100*n_stations_abovedetection/n_stations_sampled) %>% 
  dplyr::select(category, 
                category_name, 
                name_uba, 
                cas_number,
                n_stations_abovedetection,
                n_stations_sampled,
                percent_stations_abovedetection,
                n_lt, 
                n_nc,
                n_total,
                percent_nc)
                
                

                  

### Export data to EXCEL
gwq_data_list <- list(categories = categories, 
                      cas_reach = cas_reach %>% 
                        dplyr::rename(name_uba = name),
                      cas_wasserportal = cas_wasserportal %>% 
                        dplyr::rename(name_uba = name,
                                      name_wasserportal = Parameter), 
                      samples = gwq_data_export, 
                      samples_by_para = gwq_subs %>% 
                        dplyr::arrange(dplyr::desc(percent_nc)),
                      samples_by_para_and_station = gwq_subs_stations %>%
                        dplyr::arrange(dplyr::desc(percent_nc)),
                      samples_by_para_and_station_n = gwq_subs_stations_n_all %>% 
                        dplyr::arrange(dplyr::desc(percent_stations_abovedetection),
                                       dplyr::desc(percent_nc)),
                       samples_by_category_and_station = gwq_subs_by_category_and_station %>% dplyr::arrange(dplyr::desc(percent_nc)))
                      


openxlsx::write.xlsx(x = gwq_data_list,
                     file = "wasserportal_gwq_reach_data.xlsx",
                     overwrite = TRUE)
```

## Reach Substances in Wasserportal

### Total

```{r}
# cas_reach <- wasserportal::readPackageFile(file = "cas_reach.csv") 
# 
# cas_wasserportal <- wasserportal::readPackageFile(file = "cas_wasserportal.csv") %>%  
#   dplyr::count(cas_number) %>%
#   dplyr::inner_join(cas_reach, by = "cas_number") 

g <- cas_reach %>%
  dplyr::mutate(source = sprintf("UBA (n = %d)", nrow(cas_reach))) %>% 
  dplyr::bind_rows(cas_wasserportal_clean %>% 
                   dplyr::mutate(source = sprintf("Wasserportal (n = %d)", 
                                                  nrow(cas_wasserportal_clean)))) %>% 
  ggplot2::ggplot(mapping = ggplot2::aes(x = forcats::as_factor(.data$category), 
                                         fill = .data$source,
                                         col = .data$source)) + 
  ggplot2::geom_histogram(stat = "count", alpha = 0.5) +
  ggplot2::geom_text(stat="count", ggplot2::aes(label=..count..), vjust=-0.5, position="stack") +
  ggplot2::scale_x_discrete() +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="top") +
  ggplot2::labs(y = "Number of Substances", x = "Category")

  g

  ggplot2::ggsave(filename = "wasserportal_number-of-reach-substances.jpeg", 
                  plot = g,
                  width = 14, 
                  height = 11,
                  units = "cm")

  #plotly::ggplotly(g)

  
```
### By Station

```{r}

by_stations <- gwq_data_by_parameter_and_station %>%  
  dplyr::summarise(n_stations = dplyr::n()) %>% 
  dplyr::select(.data$Parameter, .data$n_stations)

wasserportal_substances <- gwq_data_by_parameter %>% 
  dplyr::left_join(by_stations, by = "Parameter") %>% 
  dplyr::right_join(cas_wasserportal, by = "Parameter") %>% 
  dplyr::arrange(.data$category, 
                 dplyr::desc(.data$n), 
                 dplyr::desc(.data$n_stations), 
                 .data$name) %>% 
  dplyr::rename(name_uba = name, 
                name_wasserportal = Parameter) %>% 
  dplyr::select(.data$category, 
                .data$name_uba,
                .data$name_wasserportal,
                .data$cas_number, 
                .data$n,
                .data$n_stations,
                .data$date_min, 
                .data$date_max)

 DT::datatable(wasserportal_substances, filter = "top", rownames = FALSE)

```

```{r}


wasserportal_substances_plot <- wasserportal_substances %>%
  dplyr::mutate(label = sprintf("%s (%s, stations: %d)", 
                                .data$name_uba, 
                                .data$cas_number, 
                                .data$n_stations),
                category = forcats::as_factor(.data$category))

wasserportal_substances_plot$label <- factor(wasserportal_substances_plot$label, 
                                             levels = wasserportal_substances_plot$label)
wasserportal_substances_plot %>% 
  ggplot2::ggplot(ggplot2::aes(x = .data$n, 
                               y = .data$label, 
                               label = .data$n,
                               fill = .data$category)) +
  ggplot2::scale_y_discrete(limits = rev) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::geom_text(size = 2, nudge_x = -1) +
  ggplot2::theme_bw() +
  ggplot2::labs(subtitle = sprintf("%d Wasserportal substances (listed in UBA table)",
                                nrow(wasserportal_substances_plot)),
                y = "", 
                x = "Number of Samples")


```



```{r}

gwq_subs_plot <- gwq_subs %>%
  dplyr::select(-n_total, -percent_nc) %>% 
  tidyr::pivot_longer(cols = c(n_lt, n_nc),
                      values_to = "n", 
                      names_to = "CensorCode") %>% 
  dplyr::mutate(CensorCode = stringr::str_remove(string = CensorCode,
                                                 pattern = "^n_")) %>% 
  dplyr::filter(n != 0) %>% 
  dplyr::arrange(.data$category, .data$name_uba) %>% 
  dplyr::mutate(label = sprintf("Cat %d: %s (%s)", 
                                .data$category,
                                .data$name_uba, 
                                .data$cas_number),
                category = forcats::as_factor(.data$category))

gwq_subs_plot$label <- as.factor(gwq_subs_plot$label)
gwq_subs_plot %>% 
  ggplot2::ggplot(ggplot2::aes(x = .data$n, 
                               y = .data$label, 
                               label = .data$n,
                               fill = .data$category)) +
  ggplot2::scale_y_discrete(limits = rev) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::geom_text(size = 2, nudge_x = -1) +
  ggplot2::theme_bw() +
  ggplot2::labs(subtitle = sprintf("%d / %d substances (>= 1 value above detection limit)",
                                nrow(gwq_subs_plot[gwq_subs_plot$CensorCode == "nc" & gwq_subs_plot$n >= 1,]),
                                   nrow(wasserportal_substances_plot)),
                                
                y = "", 
                x = "Number of Samples",
                caption = "nc: not censored, lt: below detection limit")
  
```
```



```{r}

gwq_subs_plot <- gwq_subs_stations_n %>% 
  dplyr::mutate(label = sprintf("Cat %d: %s (%s)", 
                                .data$category,
                                .data$name_uba, 
                                .data$cas_number),
                category = forcats::as_factor(.data$category))

gwq_subs_plot$label <- as.factor(gwq_subs_plot$label)
g1 <- gwq_subs_plot %>% 
  ggplot2::ggplot(ggplot2::aes(x = .data$percent_nc, 
                               y = forcats::fct_reorder(.data$label, .data$percent_nc, .desc = TRUE),
                               label = sprintf("%2.2f %% (n_samples = %d, n_stations = %d)", .data$percent_nc,.data$n_total, .data$n_stations),
                               fill = .data$category)) +                             ggplot2::scale_fill_brewer(palette="RdYlGn") +      
  ggplot2::scale_y_discrete(limits = rev) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::geom_text(size = 1.8, hjust = -0.01) +
  ggplot2::xlim(c(0,40)) +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position = "top") +
  ggplot2::labs(subtitle = sprintf("%d / %d substances (>= 1 value above detection limit)",
                                sum(gwq_subs_plot$n_nc > 0),
                                   nrow(gwq_subs_plot)),                         
                y = "", 
                x = "Percent of Samples above Detection Limit (%)")
                
ggplot2::ggsave(filename = "wasserportal_reach-substances_above-detection-limit.jpeg", 
                  plot = g1,
                  width = 17, 
                  height = 17,
                  units = "cm")
  
```
