---
title: "Surface Water"
author: "Michael Rustler"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Surface Water}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Master Data

```{r master_data}
library(wasserportal)

stations <- wasserportal::get_stations()

is_sw <- stringr::str_detect(names(stations$overview_list), "surface")

files <- wasserportal::list_masters_data_to_csv(stations$overview_list[is_sw])


```

The following surface water master data `.csv` files are available for download: 

```{r master_data_csv, echo = FALSE, results ='asis'}


cat(paste0(sprintf("- [%s](https://kwb-r.github.io/wasserportal/%s)", 
        files, 
        files),
       collapse = "\n\n"))

```

## Daily Surface Water Data

By running the code below all available `daily surface water` data of monitoring 
stations from Wasserportal Berlin will be downloaded and exported into one `.json`
file for each parameter and all available monitoring stations.


```{r surface_data_daily_export}

variables <- wasserportal::get_surfacewater_variables()
variables

sw_data_daily_list <- wasserportal::get_daily_surfacewater_data(stations,
                                                                variables)


files <- wasserportal::list_timeseries_data_to_zip(sw_data_daily_list)
files

# Data availability per parameter
sw_data_daily_list %>%
  dplyr::bind_rows() %>% 
  dplyr::count(Parameter, Einheit)

```
The following `.zip` files are available for download: 

```{r daily_surface_water_data_zip, echo = FALSE, results ='asis'}


cat(paste0(sprintf("- [%s](https://kwb-r.github.io/wasserportal/%s)", 
        files, 
        files),
       collapse = "\n\n"))

```




## Daily Surface Water Levels


```{r surface_waterlevel}

swl_master <- wasserportal::get_wasserportal_masters_data(
  master_urls = stations$overview_list$surface_water.water_level %>%
    dplyr::filter(.data$Betreiber == "Land Berlin") %>%
    dplyr::pull(.data$stammdaten_link)
)

swl_data <- sw_data_daily_list$surface_water.water_level %>% 
  dplyr::select(where(~!all(is.na(.x)))) %>%
  dplyr::left_join(swl_master[, c("Nummer", "Pegelnullpunkt_m")],
                   by = c("Messstellennummer" = "Nummer")) %>%
  dplyr::mutate(Tagesmittelwert_Pegelstand_mNN = as.numeric(.data$Pegelnullpunkt_m) + .data$Tagesmittelwert/100) %>%
  ### remove -777 for messstellennummer 5867000 (few values in 2000) resulted by step above
  dplyr::filter(.data$Tagesmittelwert_Pegelstand_mNN != -777) %>%
  dplyr::select(- .data$Pegelnullpunkt_m)

str(swl_data)

```
