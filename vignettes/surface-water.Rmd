---
title: "Surface Water"
author: "Michael Rustler"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Surface Water}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Daily Surface Water Data

By running the code below the file [surface-water_data_daily.json](https://kwb-r.github.io/wasserportal/surface-water_data_daily.json)
is created.



```{r surface_data_daily_export}
library(wasserportal)

stations <- wasserportal::get_stations()
variables <- wasserportal::get_surfacewater_variables()

sw_data_daily <- wasserportal::get_daily_surfacewater_data(stations,
                                                           variables)


# Data availability per parameter
sw_data_daily %>%
  dplyr::count(Parameter, Einheit)

jsonlite::write_json(sw_data, file = "surface-water_data_daily.json")

```


## Daily Surface Water Levels


```{r surface_waterlevel}

swl_master <- wasserportal::get_wasserportal_masters_data(
  station_ids = stations$overview_list$surface_water.water_level %>%
    dplyr::filter(.data$Betreiber == "Land Berlin") %>%
    dplyr::pull(.data$Messstellennummer)
)

swl_data <- sw_data_daily %>%
  dplyr::filter(.data$Parameter == "Wasserstand") %>%
  dplyr::select(where(~!all(is.na(.x)))) %>%
  dplyr::left_join(swl_master[, c("Nummer", "Pegelnullpunkt_m")],
                   by = c("Messstellennummer" = "Nummer")) %>%
  dplyr::mutate(Tagesmittelwert_Pegelstand_mNN = as.numeric(.data$Pegelnullpunkt_m) + .data$Tagesmittelwert/100) %>%
  ### remove -777 for messstellennummer 5867000 (few values in 2000) resulted by step above
  dplyr::filter(.data$Tagesmittelwert_Pegelstand_mNN != -777) %>%
  dplyr::select(- .data$Pegelnullpunkt_m)

```
