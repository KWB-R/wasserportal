---
title: "Tutorial"
author: "Michael Rustler"
date: "`r Sys.time()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

is_ghactions <- identical(Sys.getenv("CI"), "true")
```

## Define Helper Functions

```{r define_helpers}
write_pretty_json <- function(x, path) {
  jsonlite::write_json(x, path = path, pretty = TRUE)
}

top_filter_datatable <- function(x, caption = NULL) {
  DT::datatable(x, filter = "top", caption = caption)
}

create_title_text <- function(x, ncols) {
  paste0(
    paste0(names(x)[1L], ": ", x[1L], collapse = ", "),
    "<br>",
    "<sup>",
    paste0(names(x)[ncols], ": ", x[ncols], collapse =", "),
    "</sup>"
  )
}

also_available <- function(what, format, filename) {
  cat(paste0(
    what, 
    " is also available ", 
    format, 
    " here: ",
    "[https://kwb-r.github.io/wasserportal/", filename, "]",
    "(../", filename, ")"
  ))
}

ggplot2_date_value <- function(data, col) {
  ggplot2::ggplot(data, mapping = ggplot2::aes(
    x = Datum, 
    y = Messwert, 
    col = col
  ))
}
```

## Stations

### General overview

```{r stations_overview}
# install.packages("remotes")
# remotes::install_github("kwb-r/wasserportal", upgrade = "never", force = TRUE)
library(wasserportal)

overview_options <- wasserportal::get_overview_options()

str(overview_options)

system.time(stations <- wasserportal::get_stations())

str(stations)

write_pretty_json(stations$crosstable, "stations_crosstable.json")
```

```{r stations_crosstable}
top_filter_datatable(
  stations$crosstable, 
  "Data availabilty per monitoring station"
)
```

```{r input_ghactions0, echo = FALSE, results = 'asis', eval = is_ghactions}
also_available(
  what = paste0(
    "The crosstable data for checking data availabilty of the monitoring ",
    "stations"
  ),
  format = "in JSON format", 
  filename = "stations_crosstable.json"
)
```

### GW level

#### Master data 

Overview data of GW level stations can be requested as shown below:

```{r stations_gwl_table_overview}
top_filter_datatable(stations$overview_list$groundwater.level)
```

Master data of GW level stations can be requested as shown below:

```{r stations_gwl_table_master}
stations_gwl_master <- wasserportal::get_wasserportal_masters_data(
  master_urls = stations$overview_list$groundwater.level$stammdaten_link
)

write_pretty_json(stations_gwl_master, "stations_gwl_master.json")

top_filter_datatable(stations_gwl_master)
``` 

```{r input_ghactions1, echo = FALSE, results = 'asis', eval = is_ghactions}
also_available(
  what = "The master data of GW level stations", 
  format = "in JSON format",
  filename = "stations_gwl_master.json"
)
```

#### Trend Classification 

GW level trend classification (provided by SenWeb) is visualized below.

##### Trend Classification Histogramm

```{r stations_gwl_trend}
gwl <- stations$overview_list$groundwater.level %>% 
  dplyr::mutate(Datum = as.Date(Datum, format = "%d.%m.%Y"))

text_low_levels <- c("extrem niedrig", "sehr niedrig", "niedrig")
text_high_levels <- c("hoch", "sehr hoch", "extrem hoch")
levels_ordered <- c(text_low_levels, "normal", text_high_levels, "keine")

gwl$Klassifikation <- forcats::fct_relevel(gwl$Klassifikation, levels_ordered)

gwl_classified_only <- gwl %>% 
  dplyr::filter(Klassifikation != "keine")

percental_share_low_levels <- kwb.utils::percentage(
  sum(gwl_classified_only$Klassifikation %in% text_low_levels), 
  basis = nrow(gwl_classified_only)
)

percental_share_high_levels <- kwb.utils::percentage(
  sum(gwl_classified_only$Klassifikation %in% text_high_levels), 
  basis = nrow(gwl_classified_only)
)

title_text <- sprintf(
  "GW level classification (n = %d out of %d have 'classification' data)",
  nrow(gwl_classified_only), 
  nrow(gwl)
)

g1 <- gwl_classified_only %>% 
  dplyr::count(Klassifikation, Grundwasserspannung) %>% 
  dplyr::mutate(percental_share = kwb.utils::percentage(n, nrow(gwl))) %>% 
  ggplot2::ggplot(ggplot2::aes(
    x = Klassifikation,
    y = percental_share,
    fill = Grundwasserspannung
  )) +
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::labs(
    title = title_text,
    x = "Classification",
    y = "Percental share (%)"
  ) +
  ggplot2::theme_bw()

plotly::ggplotly(g1)
```

`r round(percental_share_low_levels, 2L)` percent of all considered 
`r nrow(gwl_classified_only)` GW level monitoring stations containing `classification` data (out of `r nrow(gwl)` provided by SenWeb) indicate 
`below normal` 
(`r paste(text_low_levels, collapse = ", ")`) GW levels. However, only 
`r round(percental_share_low_levels, 2L)` percent are indicate `above normal` 
(`r paste(text_high_levels, collapse = ", ")`) 
GW levels.

##### Trend Classification Map

```{r stations_gwl_trend_spatially}
level_colors <- data.frame(
  Klassifikation = levels_ordered, 
  classi_color = c(
    "darkred", 
    "red", 
    "orange", 
    "green", 
    "lightblue", 
    "blue", 
    "darkblue", 
    "grey"
  )
)

rechtswert <- "Rechtswert_UTM_33_N"
hochwert <- "Hochwert_UTM_33_N"

gwl_classified_only_with_coords <- gwl_classified_only %>% 
  dplyr::mutate(
    Messstellennummer = as.character(Messstellennummer),
  ) %>% 
  dplyr::left_join(
    stations_gwl_master %>%
      dplyr::select("Nummer", rechtswert, hochwert) %>% 
      dplyr::rename(Messstellennummer = "Nummer"),
    by = "Messstellennummer"
  ) %>% 
  dplyr::left_join(
    level_colors, 
    by = "Klassifikation"
  ) %>% 
  sf::st_as_sf(
    coords = c(rechtswert, hochwert), 
    crs = 25833
  ) %>% 
  sf::st_transform(crs = 4326)

# Create a vector of labels for each row in gwl_classified_only_with_coords
labs <- wasserportal::columns_to_labels(
  data = gwl_classified_only_with_coords, 
  columns = c(
    "Messstellennummer", 
    "Grundwasserspannung", 
    "Klassifikation", 
    "Datum"
  ),
  fmt = "<p>%s: %s</p>",
  sep = ""
)

# Print Map
gwlmap <- gwl_classified_only_with_coords %>% 
  leaflet::leaflet() %>%
  leaflet::addTiles() %>% 
  leaflet::addProviderTiles(leaflet::providers$CartoDB.Positron) %>%
  leaflet::addCircles(
    color = ~classi_color,
    label = lapply(labs, htmltools::HTML)
  ) %>% 
  leaflet::addLegend(
    position = "topright",
    colors = level_colors$classi_color,
    labels = level_colors$Klassifikation,
    title = sprintf(
      "Classification (latest data: %s)",
      max(gwl_classified_only_with_coords$Datum)
    )
  )

htmlwidgets::saveWidget(
  gwlmap, 
  "./map_gwl-trend.html", 
  title = "GW level trend"
)

gwlmap
```

```{r input_ghactions_map, echo=FALSE, results='asis', eval=is_ghactions}
also_available(
  what = "GW level trend plot", 
  format = "on a full html page", 
  filename = "map_gwl-trend.html"
)
```

#### Download and Plotting One Station

for total period available.

```{r test_gwl_download_single, eval = FALSE}
station_gwl <- stations$overview_list$groundwater.level[1L, ]

ncols <- 2:ncol(station_gwl)

gw_level <- wasserportal::read_wasserportal_raw_gw(
  station = station_gwl$Messstellennummer, 
  stype = "gwl"
) %>% 
  dplyr::mutate(Label = sprintf("%s (%s)", Parameter, Einheit))

head(gw_level)

g <- gw_level %>% 
  ggplot2_date_value(col = "Label") +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::theme_bw()

title_subtitle <- create_title_text(x = station_gwl, ncols = ncols)

plotly::ggplotly(g) %>%
  plotly::layout(title = list(text = title_subtitle))
```

#### Download and Plotting Multiple Stations

```{r test_gwl_download_multiple, eval = FALSE}
debug <- FALSE

gw_level_multi <- data.table::rbindlist(lapply(
  stations$overview_list$groundwater.level$Messstellennummer, 
  function(id) kwb.utils::catAndRun(
    sprintf("Downloading Messstellennummer == '%s'", id), 
    wasserportal::read_wasserportal_raw_gw(station = id, stype = "gwl"), 
    dbg = debug
  )
))

readr::write_csv(gw_level_multi, file = "groundwater_level.csv")

# Plot 10 GW level
selected_stations <- stations$overview_list$groundwater.level$Messstellennummer[1:10]

g <- gw_level_multi %>% 
  dplyr::filter(Messstellennummer %in% selected_stations) %>% 
  dplyr::mutate(Messstellennummer = as.character(Messstellennummer)) %>% 
  ggplot2_date_value(col = "Messstellennummer") +
  ggplot2::labs(title = "GW level (m above NN)") +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::theme_bw()

plotly::ggplotly(g)
```

```{r input_ghactions_gwl_download, echo = FALSE, results = 'asis', eval = is_ghactions}
also_available(
  what = "The data of all GW level stations",
  format = "in CSV format", 
  filename = "groundwater_level.csv"
)
```

### GW quality

Overview data of GW level stations can be requested as shown below:

```{r stations_gwq_table_overview}
stations_gwq <- wasserportal::get_wasserportal_stations_table(
  type = overview_options$groundwater$quality
)

top_filter_datatable(stations_gwq)
```

Master data of GW quality stations can be requested as shown below:

```{r stations_gwq_table_master}
stations_gwq_master <- wasserportal::get_wasserportal_masters_data(
  master_urls = stations_gwq$stammdaten_link
)

write_pretty_json(stations_gwq_master, "stations_gwq_master.json")
``` 

```{r input_ghactions2, echo = FALSE, results = 'asis', eval = is_ghactions}
also_available(
  what = "The master data of GW quality stations",
  format = "in JSON format",
  filename = "stations_gwq_master.json"
)
```

#### GW Quality: Download and Plotting One Station

```{r test_gwq_download_single, eval = FALSE}
station_gwq <- stations$overview_list$groundwater.quality[1L, ]

ncols <- 2:ncol(station_gwq)

gw_quality <- wasserportal::read_wasserportal_raw_gw(
  station = station_gwq$Messstellennummer, 
  stype = "gwq"
)

head(gw_quality)

unique(gw_quality$Parameter)

g <- gw_quality %>%  
  dplyr::filter(Parameter == "Sulfat") %>% 
  ggplot2_date_value(col = "Parameter") +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::theme_bw()

title_subtitle <- create_title_text(x = station_gwq, ncols = ncols)

plotly::ggplotly(g) %>%
  plotly::layout(title = list(text = title_subtitle))
```

#### GW Quality: Download and Plotting Multiple Stations

```{r test_gwq_download_multiple, eval = FALSE}
debug <- FALSE

gw_quality_multi <- data.table::rbindlist(lapply(
  stations$overview_list$groundwater.quality$Messstellennummer, 
  function(id) kwb.utils::catAndRun(
    sprintf("Downloading Messstellennummer == '%s'", id), 
    wasserportal::read_wasserportal_raw_gw(station = id, stype = "gwq"), 
    dbg = debug
  )
))

readr::write_csv(gw_quality_multi, "groundwater_quality.csv")

# Plot 10 GW quality 
selected_stations <- stations$overview_list$groundwater.quality$Messstellennummer[1:10]

g <- gw_quality_multi %>% 
  dplyr::filter(Messstellennummer %in% selected_stations) %>% 
  dplyr::mutate(Messstellennummer = as.character(Messstellennummer)) %>% 
  dplyr::filter(Parameter == "Sulfat") %>% 
  ggplot2_date_value(col = "Messstellennummer") +
  ggplot2::labs(title = "GW quality (Sulfat)") +
  ggplot2::geom_line() +
  ggplot2::geom_point() +
  ggplot2::theme_bw()

plotly::ggplotly(g)
```

```{r input_ghactions_gwq_download, echo = FALSE, results = 'asis', eval = is_ghactions}
also_available(
  what = "The data of all GW quality stations", 
  format = "in CSV format", 
  filename = "groundwater_quality.csv"
)
```
